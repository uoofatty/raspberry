>>给wlan0配置一个静态IP

:~ $ sudo vim /etc/network/interfaces

-------------- 配置 ----------------

auto eth0
iface eth0 inet dhcp

auto wlan0
iface wlan0 inet static
        address 192.168.220.1
        netmask 255.255.255.0
        gateway 192.168.220.1

        ------------------------------------

////////////////////////////////////////////////////////////////////////////////////////////

>>hostapd
                
        新增配置文件sudo vi /etc/hostapd/hostapd.conf
        (如无法保存，应创建文件并授权)
        
        :~ $ sudo vim /etc/hostapd/hostapd.conf

        -------------- 配置 ----------------

        interface=wlan0

        driver=nl80211

        ssid=[wifi-name]

        hw_mode=g

        channel=11

        ieee80211n=1

        macaddr_acl=0

        auth_algs=1

        ignore_broadcast_ssid=0

        wpa=2

        wpa_key_mgmt=WPA-PSK

        wpa_passphrase=[wifi-password]

        rsn_pairwise=TKIP CCMP
        
        （安装hostapd后可测试！）
        测试一下sudo /usr/sbin/hostapd /etc/hostapd/hostapd.conf
        现在你可以在手机上搜到Pi3-AP的wifi，输入密码连接上之后会发现一直等待的状态,
        因为DHCP服务还没配置，我们下一步就要配置dnsmasq。
        
        -------------------------------------
        
        （安装hostapd）
        安装hostapd之后，系统服务已经添加了，但是配置文件的地址还需要配置
        
        :~ $ sudo vim /etc/default/hostapd

        -------------- 配置 ----------------

        DAEMON_CONF="/etc/hostapd/hostapd.conf"
        
        ------------------------------------

////////////////////////////////////////////////////////////////////////////////////////////

>>dnsmasq

        :~ $ sudo vim /etc/dnsmasq.conf

        -------------- 配置 ----------------

        interface=wlan0

        listen-address=192.168.220.1

        no-dhcp-interface=lo,eth0

        bind-interfaces

        dhcp-range=192.168.220.50,192.168.220.150,72h

        ------------------------------------

////////////////////////////////////////////////////////////////////////////////////////////

>>iptables

        :~ $ sudo vim /etc/sysctl.conf
        --------------- 配置 -------------------

        net.ipv4.ip_forward=1

        //输入sudo sysctl -p 使配置立刻生效.
        :~ $ sudo sysctl -p
        
        >>>>>----------start-----------<<<<<  [配置后,内网成功,外网失败]
        //使用wifi共享internet,需要配置nat
        sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE  
        sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
        sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
        
        //把TCP流量重定向到指定端口
        sudo iptables -t nat -A PREROUTING -p tcp -s 127.0.0.1 -j DNAT --to 服务器地址
        >>>>>---------- end -----------<<<<<
        
        //设定 iptables 规则，命令如下 [配置后,内、外网成功]
        sudo iptables -t nat -N V2RAY
        sudo iptables -t nat -A V2RAY -d 192.168.0.0/16 -j RETURN
        sudo iptables -t nat -A V2RAY -p tcp -j REDIRECT --to-ports 12345
        sudo iptables -t nat -A PREROUTING -p tcp -j V2RAY
        
         >>>>>----------start-----------<<<<<
        //UDP 流量透明代理的 iptables 规则，命令如下  [配置后，无法获取IP地址]
        sudo ip rule add fwmark 1 table 100
        sudo sudo ip route add local 0.0.0.0/0 dev lo table 100
        sudo iptables -t mangle -N V2RAY_MASK
        sudo iptables -t mangle -A V2RAY_MASK  -d 192.168.0.0/16 -j RETURN
        sudo iptables -t mangle -A V2RAY_MASK -p udp -j TPROXY --on-port 12345 --tproxy-mark 1
        sudo iptables -t mangle -A PREROUTING -p udp -j V2RAY_MASK
        >>>>>---------- end -----------<<<<<
        
        //每次重启之后iptables的配置nat都会丢失，所以需要保存一下
        sudo sh -c "iptables-save > /etc/iptables.ipv4.nat"
        sudo iptables-restore < /etc/iptables.ipv4.nat
        
        可以把 sudo iptables-restore < /etc/iptables.ipv4.nat 添加到 /etc/rc.local 开机启动
        
        //启动服务
        sudo service hostapd start 
        sudo service dnsmasq start
        ----------------------------------------

配置完成后reboot

参考文档 https://python.freelycode.com/contribution/detail/336
